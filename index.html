<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Malefiz â€” Ambiance Plateau</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* PALETTE "CAFE JEUX" - Conviviale et Chaude */
      --bg-app: #f4e9d5;        /* Beige chaud (parchemin) */
      --panel-bg: #fffcf5;      /* CrÃ¨me trÃ¨s clair pour les cartes */
      --text-main: #3e2723;     /* Brun foncÃ© (bois) pour le texte */
      --text-muted: #8d6e63;    /* Brun clair */
      
      --primary: #d84315;       /* Orange brulÃ© (brique) pour les actions principales */
      --primary-hover: #bf360c;
      
      --btn-sec: #e6d0b3;       /* Beige foncÃ© pour les boutons secondaires */
      --btn-sec-text: #4e342e;
      
      --board-bg: #e0cfb1;      /* Fond du plateau (bois clair) */
      --border-soft: #d7ccc8;
      
      --shadow-card: 0 8px 20px rgba(62, 39, 35, 0.1); /* Ombre douce brune */
      --radius: 18px;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }
    
    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: 'Nunito', system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px 10px;
    }

    h3 { margin-top: 0; color: var(--text-main); font-weight: 800; font-size: 1.5rem; margin-bottom: 15px; }
    label { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; }

    /* Cartes (Menu & Jeu) */
    .card {
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 1100px;
      box-shadow: var(--shadow-card);
      margin-bottom: 20px;
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { display: flex; flex-direction: column; gap: 8px; }

    /* Inputs */
    input, select {
      font-family: inherit;
      border-radius: 10px;
      border: 2px solid var(--border-soft); /* Bordure un peu plus Ã©paisse style cartoon/jeu */
      background: #fff;
      padding: 12px 16px;
      color: var(--text-main);
      font-size: 1rem;
      font-weight: 600;
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--primary);
      background: #fff;
    }

    /* Boutons */
    button {
      font-family: inherit;
      border-radius: 12px;
      border: none;
      padding: 12px 24px;
      font-weight: 800; /* Police bien grasse */
      cursor: pointer;
      font-size: 1rem;
      background: var(--btn-sec);
      color: var(--btn-sec-text);
      box-shadow: 0 4px 0 rgba(0,0,0,0.1); /* Petit effet 3D */
      transform: translateY(0);
    }
    button:hover:not(:disabled) {
      background: #dcc09d;
      transform: translateY(-2px);
      box-shadow: 0 6px 0 rgba(0,0,0,0.1);
    }
    button:active:not(:disabled) {
      transform: translateY(2px);
      box-shadow: 0 0 0 rgba(0,0,0,0.1);
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }

    button.primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 0 #9f2a06; /* Ombre foncÃ©e de la mÃªme teinte */
    }
    button.primary:hover:not(:disabled) {
      background: var(--primary-hover);
      box-shadow: 0 6px 0 #9f2a06;
    }

    /* Plateau */
    #wrap {
      overflow: hidden;
      border-radius: var(--radius);
      background: var(--board-bg);
      box-shadow: inset 0 0 30px rgba(62, 39, 35, 0.1);
      border: 4px solid #fff; /* Cadre blanc autour du plateau */
      position: relative;
    }

    #svg { touch-action: none; display: block; width: 100%; height: 70vh; }

    /* SVG Styles */
    .edge { stroke: #a1887f; stroke-width: 5; stroke-linecap: round; opacity: 0.7; }
    .node { fill: #fdfbf7; stroke: #d7ccc8; stroke-width: 2; }
    .barricade { fill: #212121; stroke: #000; stroke-width: 1; filter: drop-shadow(0px 3px 2px rgba(0,0,0,0.4)); }
    .pawn { stroke: rgba(0,0,0,0.2); stroke-width: 1; filter: drop-shadow(0px 4px 3px rgba(0,0,0,0.3)); }
    
    .hint-origin { fill: rgba(255,255,255,0.6); stroke: var(--primary); stroke-width: 4; cursor: pointer; animation: pulse 1.5s infinite; }
    .hint-target { fill: rgba(216, 67, 21, 0.2); stroke: var(--primary); stroke-width: 3; cursor: pointer; stroke-dasharray: 8 4; }
    .select { fill: transparent; stroke: #ffca28; stroke-width: 5; pointer-events: none; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

    /* Tags Joueurs */
    .tag {
      padding: 8px 16px;
      border-radius: 99px;
      background: #fff;
      border: 2px solid #efebe9;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .dot { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 2px solid rgba(0,0,0,0.1); }

    /* Logs & Infos */
    #log {
      height: 150px;
      overflow: auto;
      background: #fff;
      border: 2px solid var(--border-soft);
      border-radius: 12px;
      padding: 12px;
      white-space: pre-wrap;
      font-size: 13px;
      color: var(--text-muted);
      font-family: 'Nunito', sans-serif;
    }
    .notice { font-size: 14px; color: var(--primary); font-weight: 700; margin-left: 8px; }
    
    /* Header Jeu */
    .game-header {
      background: #fff;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      margin-bottom: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    #dice { font-size: 1.2rem; font-weight: 800; color: var(--text-main); background: #f5f5f5; padding: 8px 16px; border-radius: 10px; border: 2px solid #e0e0e0; }
    #turn { color: var(--primary); }

    /* Overlay Victoire */
    #winOverlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(62, 39, 35, 0.85); z-index: 9999; backdrop-filter: blur(3px); }
    #winBox { background: #fff; border-radius: 24px; padding: 40px; max-width: 500px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 4px solid var(--primary); }
    #winBox h2 { margin: 0 0 16px; color: var(--primary); font-size: 2.2rem; }
    #winBox p { font-size: 1.2rem; line-height: 1.6; color: var(--text-main); margin-bottom: 24px; }
    #winClose { width: 100%; background: var(--text-main); color: #fff; border:none; box-shadow:none;}
  </style>
</head>
<body>

<section id="menu" class="card">
  <div style="text-align:center; margin-bottom:20px;">
    <h3>ðŸŽ² Malefiz en Ligne</h3>
    <p style="color:var(--text-muted); margin:0;">Le jeu de barricade classique</p>
  </div>

  <div class="row">
    <div class="col" style="min-width:200px;flex:1">
      <label>Ton Pseudo</label>
      <input id="m_name" placeholder="ex: Camille">
    </div>
    <div class="col" style="width:180px">
      <label>Ta Couleur</label>
      <select id="m_color">
        <option value="red">ðŸ”´ Rouge</option>
        <option value="blue">ðŸ”µ Bleu</option>
        <option value="green">ðŸŸ¢ Vert</option>
        <option value="yellow">ðŸŸ¡ Jaune</option>
      </select>
    </div>
    <div class="col" style="min-width:200px;flex:1">
      <label>Code de la partie</label>
      <input id="m_game" placeholder="ex: famille1">
    </div>
  </div>
  
  <div class="row" style="margin-top:24px; justify-content: center; gap: 20px;">
    <button id="m_join">Rejoindre une table</button>
    <button id="m_create" class="primary">CrÃ©er une table</button>
  </div>
  
  <div id="lobby" style="display:none; margin-top:30px; background: rgba(0,0,0,0.03); padding: 20px; border-radius: 16px;">
    <div style="margin-bottom:12px; color:var(--text-main); font-weight:800; text-transform:uppercase; letter-spacing:1px; font-size:0.9rem;">Joueurs Ã  table :</div>
    <div id="lobbyList" class="row" style="gap:10px"></div>
    
    <div class="row" style="margin-top:24px; align-items:center; gap:15px; border-top: 2px dashed rgba(0,0,0,0.1); padding-top: 20px;">
      <button id="m_start" class="primary" style="flex:1;">ðŸš€ Lancer la partie !</button>
      <div style="flex:2; font-size:0.9rem; color:var(--text-muted); line-height:1.4;">
        <strong>Note :</strong> Seul l'hÃ´te (celui qui a crÃ©Ã©) peut cliquer sur lancer. Il faut min. 2 joueurs.
      </div>
    </div>
  </div>
</section>

<section id="game" class="card" style="display:none">
  <div class="game-header row" style="align-items:center; justify-content:space-between">
    <div class="row" style="gap:12px; align-items:center; flex:1;">
      <button id="roll" class="primary">ðŸŽ² Lancer le dÃ©</button>
      <div id="dice">DÃ© : â€”</div>
      <div style="display:flex; flex-direction:column; justify-content:center;">
        <div style="font-size:0.85rem; color:var(--text-muted); font-weight:700;">C'est au tour de :</div>
        <div style="font-size:1.1rem;"><strong id="turn">â€”</strong></div>
      </div>
    </div>
    <div id="players" class="row" style="gap:6px; justify-content:flex-end;"></div>
  </div>

  <div id="phase" class="notice" style="text-align:center; margin-bottom:10px; height:20px;"></div>

  <div id="wrap">
    <svg id="svg" viewBox="0 0 1090 1300" xmlns="http://www.w3.org/2000/svg">
      <g id="edges"></g>
      <g id="nodes"></g>
      <g id="homes"></g>
      <g id="pieces"></g>
      <g id="ui"></g>
    </svg>
  </div>

  <div class="col" style="margin-top:20px">
    <div style="font-size:0.9rem; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Historique</div>
    <div id="log"></div>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqZOF5bsuzH7dH3TvQiY9JknZWXYJsEE4",
  authDomain: "barricade-en-ligne.firebaseapp.com",
  databaseURL: "https://barricade-en-ligne-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "barricade-en-ligne",
  storageBucket: "barricade-en-ligne.firebasestorage.app",
  messagingSenderId: "1094029683667",
  appId: "1:1094029683667:web:e3d6b9ad3b44b337d29d26"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const COLORS={red:"#d32f2f",blue:"#1976d2",green:"#388e3c",yellow:"#fbc02d"};
const NODES = [{"id": "n1", "x": 120, "y": 900, "n": 1}, {"id": "n2", "x": 170, "y": 900, "n": 2}, {"id": "n3", "x": 220, "y": 900, "n": 3}, {"id": "n4", "x": 270, "y": 900, "n": 4}, {"id": "n5", "x": 320, "y": 900, "n": 5}, {"id": "n6", "x": 370, "y": 900, "n": 6}, {"id": "n7", "x": 420, "y": 900, "n": 7}, {"id": "n8", "x": 470, "y": 900, "n": 8}, {"id": "n9", "x": 520, "y": 900, "n": 9}, {"id": "n10", "x": 570, "y": 900, "n": 10}, {"id": "n11", "x": 620, "y": 900, "n": 11}, {"id": "n12", "x": 670, "y": 900, "n": 12}, {"id": "n13", "x": 720, "y": 900, "n": 13}, {"id": "n14", "x": 770, "y": 900, "n": 14}, {"id": "n15", "x": 820, "y": 900, "n": 15}, {"id": "n16", "x": 870, "y": 900, "n": 16}, {"id": "n17", "x": 920, "y": 900, "n": 17}, {"id": "n18", "x": 120, "y": 840, "n": 18}, {"id": "n19", "x": 320, "y": 840, "n": 19}, {"id": "n20", "x": 520, "y": 840, "n": 20}, {"id": "n21", "x": 720, "y": 840, "n": 21}, {"id": "n22", "x": 920, "y": 840, "n": 22}, {"id": "n23", "x": 120, "y": 780, "n": 23}, {"id": "n24", "x": 170, "y": 780, "n": 24}, {"id": "n25", "x": 220, "y": 780, "n": 25}, {"id": "n26", "x": 270, "y": 780, "n": 26}, {"id": "n27", "x": 320, "y": 780, "n": 27}, {"id": "n28", "x": 370, "y": 780, "n": 28}, {"id": "n29", "x": 420, "y": 780, "n": 29}, {"id": "n30", "x": 470, "y": 780, "n": 30}, {"id": "n31", "x": 520, "y": 780, "n": 31}, {"id": "n32", "x": 570, "y": 780, "n": 32}, {"id": "n33", "x": 620, "y": 780, "n": 33}, {"id": "n34", "x": 670, "y": 780, "n": 34}, {"id": "n35", "x": 720, "y": 780, "n": 35}, {"id": "n36", "x": 770, "y": 780, "n": 36}, {"id": "n37", "x": 820, "y": 780, "n": 37}, {"id": "n38", "x": 870, "y": 780, "n": 38}, {"id": "n39", "x": 920, "y": 780, "n": 39}, {"id": "n40", "x": 220, "y": 720, "n": 40}, {"id": "n41", "x": 420, "y": 720, "n": 41}, {"id": "n42", "x": 620, "y": 720, "n": 42}, {"id": "n43", "x": 820, "y": 720, "n": 43}, {"id": "n44", "x": 220, "y": 660, "n": 44}, {"id": "n45", "x": 270, "y": 660, "n": 45}, {"id": "n46", "x": 320, "y": 660, "n": 46}, {"id": "n47", "x": 370, "y": 660, "n": 47}, {"id": "n48", "x": 420, "y": 660, "n": 48}, {"id": "n49", "x": 470, "y": 660, "n": 49}, {"id": "n50", "x": 520, "y": 660, "n": 50}, {"id": "n51", "x": 570, "y": 660, "n": 51}, {"id": "n52", "x": 620, "y": 660, "n": 52}, {"id": "n53", "x": 670, "y": 660, "n": 53}, {"id": "n54", "x": 720, "y": 660, "n": 54}, {"id": "n55", "x": 770, "y": 660, "n": 55}, {"id": "n56", "x": 820, "y": 660, "n": 56}, {"id": "n57", "x": 320, "y": 600, "n": 57}, {"id": "n58", "x": 720, "y": 600, "n": 58}, {"id": "n59", "x": 320, "y": 540, "n": 59}, {"id": "n60", "x": 370, "y": 540, "n": 60}, {"id": "n61", "x": 420, "y": 540, "n": 61}, {"id": "n62", "x": 470, "y": 540, "n": 62}, {"id": "n63", "x": 520, "y": 540, "n": 63}, {"id": "n64", "x": 570, "y": 540, "n": 64}, {"id": "n65", "x": 620, "y": 540, "n": 65}, {"id": "n66", "x": 670, "y": 540, "n": 66}, {"id": "n67", "x": 720, "y": 540, "n": 67}, {"id": "n68", "x": 420, "y": 480, "n": 68}, {"id": "n69", "x": 620, "y": 480, "n": 69}, {"id": "n70", "x": 420, "y": 420, "n": 70}, {"id": "n71", "x": 470, "y": 420, "n": 71}, {"id": "n72", "x": 520, "y": 420, "n": 72}, {"id": "n73", "x": 570, "y": 420, "n": 73}, {"id": "n74", "x": 620, "y": 420, "n": 74}, {"id": "n75", "x": 520, "y": 360, "n": 75}, {"id": "n76", "x": 120, "y": 300, "n": 76}, {"id": "n77", "x": 170, "y": 300, "n": 77}, {"id": "n78", "x": 220, "y": 300, "n": 78}, {"id": "n79", "x": 270, "y": 300, "n": 79}, {"id": "n80", "x": 320, "y": 300, "n": 80}, {"id": "n81", "x": 370, "y": 300, "n": 81}, {"id": "n82", "x": 420, "y": 300, "n": 82}, {"id": "n83", "x": 470, "y": 300, "n": 83}, {"id": "n84", "x": 520, "y": 300, "n": 84}, {"id": "n85", "x": 570, "y": 300, "n": 85}, {"id": "n86", "x": 620, "y": 300, "n": 86}, {"id": "n87", "x": 670, "y": 300, "n": 87}, {"id": "n88", "x": 720, "y": 300, "n": 88}, {"id": "n89", "x": 770, "y": 300, "n": 89}, {"id": "n90", "x": 820, "y": 300, "n": 90}, {"id": "n91", "x": 870, "y": 300, "n": 91}, {"id": "n92", "x": 920, "y": 300, "n": 92}, {"id": "n93", "x": 120, "y": 240, "n": 93}, {"id": "n94", "x": 920, "y": 240, "n": 94}, {"id": "n95", "x": 120, "y": 180, "n": 95}, {"id": "n96", "x": 170, "y": 180, "n": 96}, {"id": "n97", "x": 220, "y": 180, "n": 97}, {"id": "n98", "x": 270, "y": 180, "n": 98}, {"id": "n99", "x": 320, "y": 180, "n": 99}, {"id": "n100", "x": 370, "y": 180, "n": 100}, {"id": "n101", "x": 420, "y": 180, "n": 101}, {"id": "n102", "x": 470, "y": 180, "n": 102}, {"id": "n103", "x": 520, "y": 180, "n": 103}, {"id": "n104", "x": 570, "y": 180, "n": 104}, {"id": "n105", "x": 620, "y": 180, "n": 105}, {"id": "n106", "x": 670, "y": 180, "n": 106}, {"id": "n107", "x": 720, "y": 180, "n": 107}, {"id": "n108", "x": 770, "y": 180, "n": 108}, {"id": "n109", "x": 820, "y": 180, "n": 109}, {"id": "n110", "x": 870, "y": 180, "n": 110}, {"id": "n111", "x": 920, "y": 180, "n": 111}, {"id": "n112", "x": 520, "y": 120, "n": 112}];

function getNodeById(id){
  for (let i=0;i<NODES.length;i++){ const n = NODES[i]; if(n.id===id) return n; }
  return null;
}

const ADJ = {"n112": ["n103"], "n95": ["n96", "n93"], "n96": ["n97", "n95"], "n97": ["n98", "n96"], "n98": ["n99", "n97"], "n99": ["n100", "n98"], "n100": ["n101", "n99"], "n101": ["n102", "n100"], "n102": ["n103", "n101"], "n103": ["n104", "n102", "n112"], "n10
