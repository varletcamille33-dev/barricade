<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Malefiz – plateau fidèle (en ligne)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    :root { --beige:#f5e4b2; --line:#7a5a3b; --text:#3a2c1f; --panel:#fff6e8; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--beige);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .card{background:var(--panel);border:1px solid #e8d9ba;border-radius:14px;padding:14px;margin:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    input,select,button{font:inherit;border-radius:12px;border:1px solid #decab0;background:#fff;padding:10px 12px;color:var(--text)}
    button{background:#cfae7e;border-color:#cfae7e;color:#2b1d12;font-weight:700}
    button.primary{background:#b97a2a;border-color:#b97a2a;color:#fff}
    #svg{width:100%;height:auto;display:block;background:#f6e8c9;border-radius:10px}
    .edge{stroke:#9c744a;stroke-width:4;stroke-linecap:round}
    .node{fill:#f8efe0;stroke:#a88353;stroke-width:2}
    .goal{fill:#79c36a;stroke:#357a38;stroke-width:3}
    .barricade{fill:#000;stroke:#222;stroke-width:2}
    .pawn{stroke:#6b4a2e;stroke-width:2}
    .hint{fill:transparent;stroke:#c77d2a;stroke-width:3}
    .homes circle{stroke:#6b4a2e;stroke-width:2}
    .tag{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #e3d4bd;font-size:13px;margin-right:6px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:-1px}
    #log{height:140px;overflow:auto;background:#fff;border:1px solid #eadcc7;border-radius:10px;padding:8px;white-space:pre-wrap;font-size:12px}
  </style>
</head>
<body>
<section id="menu" class="card">
  <h3>Malefiz — créer/rejoindre</h3>
  <div class="row">
    <div class="col" style="min-width:180px;flex:1">
      <label>Pseudo</label><input id="m_name" placeholder="ex: Camille">
    </div>
    <div class="col" style="width:150px">
      <label>Couleur</label>
      <select id="m_color"><option value="red">Rouge</option><option value="blue">Bleu</option><option value="green">Vert</option><option value="yellow">Jaune</option></select>
    </div>
    <div class="col" style="min-width:180px;flex:1">
      <label>Code de partie</label><input id="m_game" placeholder="ex: famille1">
    </div>
  </div>
  <div class="row" style="margin-top:6px">
    <button id="m_create" class="primary">Créer la partie</button>
    <button id="m_join">Rejoindre la partie</button>
  </div>
  <div id="lobby" style="display:none;margin-top:10px">
    <div><strong>Joueurs connectés</strong></div>
    <div id="lobbyList" class="row"></div>
    <div class="row" style="margin-top:10px"><button id="m_start" class="primary">Démarrer la partie</button></div>
  </div>
</section>

<section id="game" class="card" style="display:none">
  <div class="row" style="align-items:center;justify-content:space-between">
    <div class="row" style="gap:12px;align-items:center">
      <button id="roll">🎲 Lancer le dé</button>
      <div id="dice">Dé : —</div>
      <div>Tour : <strong id="turn">—</strong></div>
    </div>
    <div id="players" class="row"></div>
  </div>
  <div style="margin-top:10px">
    <svg id="svg" viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
      <g id="edges"></g>
      <g id="nodes"></g>
      <g id="homes" class="homes"></g>
      <g id="pieces"></g>
    </svg>
  </div>
  <div class="col" style="margin-top:10px">
    <div><strong>Journal</strong></div><div id="log"></div>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// ⚠️ COLLE ICI TA CONFIG
const firebaseConfig = {
  apiKey: "REMPLACE_MOI",
  authDomain: "REMPLACE_MOI.firebaseapp.com",
  databaseURL: "https://REMPLACE_MOI-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "REMPLACE_MOI",
  storageBucket: "REMPLACE_MOI.appspot.com",
  messagingSenderId: "REMPLACE",
  appId: "REMPLACE"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const COLORS={red:"#e74b4b",blue:"#3a7bff",green:"#2fbf71",yellow:"#e5c14b"};

// ---- MENU
const menu=document.getElementById('menu'), game=document.getElementById('game');
const mName=document.getElementById('m_name'), mColor=document.getElementById('m_color'), mGame=document.getElementById('m_game');
const mCreate=document.getElementById('m_create'), mJoin=document.getElementById('m_join'), mStart=document.getElementById('m_start');
const lobby=document.getElementById('lobby'), lobbyList=document.getElementById('lobbyList');
let ME="", MYCOLOR="red", gameRef=null, IS_HOST=false;

function blankState(){return{host:"",started:false,order:[],turnIndex:0,dice:0,winner:"",players:{},colors:{red:false,blue:false,green:false,yellow:false},barricades:[]};}
function ensure(st){ if(!st) st=blankState(); st.players=st.players||{}; st.colors=st.colors||{red:false,blue:false,green:false,yellow:false}; st.order=st.order||[]; st.barricades=st.barricades||[]; return st; }
function log(t){ const el=document.getElementById('log'); el.textContent = t+"\n"+el.textContent; }

mCreate.onclick = async ()=>{
  const id=mGame.value.trim(), name=mName.value.trim(), color=mColor.value; if(!id||!name) return alert("Pseudo + code");
  ME=name; MYCOLOR=color; IS_HOST=true; gameRef=ref(db,"games/"+id);
  await set(gameRef, blankState());
  await runTransaction(gameRef,(st)=>{ st=ensure(st); st.host=name; st.players[name]={color,pawns:Array.from({length:5}).map(()=>({pos:"home",atHome:true})),won:false}; st.colors[color]=true; st.order=[name]; return st; });
  subscribe(id); lobby.style.display="block";
};
mJoin.onclick = async ()=>{
  const id=mGame.value.trim(), name=mName.value.trim(), color=mColor.value; if(!id||!name) return alert("Pseudo + code");
  ME=name; MYCOLOR=color; IS_HOST=false; gameRef=ref(db,"games/"+id);
  await runTransaction(gameRef,(st)=>{ st=ensure(st); if(st.started){alert("Partie déjà démarrée");return;} if(st.players[name]){alert("Pseudo déjà pris");return;} if(st.colors[color]){alert("Couleur déjà prise");return;} st.players[name]={color,pawns:Array.from({length:5}).map(()=>({pos:"home",atHome:true})),won:false}; st.colors[color]=true; st.order.push(name); return st; });
  subscribe(id); lobby.style.display="block";
};
mStart.onclick = async ()=>{
  if(!IS_HOST) return;
  await runTransaction(gameRef,(st)=>{ st=ensure(st); if(Object.keys(st.players).length<2){alert("Au moins 2 joueurs"); return;}
    st.started=true; st.turnIndex=0; st.dice=0; st.winner="";
    st.barricades = [23,27,31,35,39,61,65,72,75,84,112].map(n=>"n"+n);
    return st;
  });
};

function subscribe(id){
  onValue(ref(db,"games/"+id),(snap)=>{
    const st=ensure(snap.val());
    for(const o of [...mColor.options]) o.disabled = !!st.colors[o.value];
    lobbyList.innerHTML=""; Object.entries(st.players).forEach(([n,p])=>{ const d=document.createElement('div'); d.className='tag'; d.innerHTML=`<span class="dot" style="background:${COLORS[p.color]}"></span>${n}`; lobbyList.appendChild(d); });
    if(st.started){ menu.style.display="none"; game.style.display="block"; }
    drawState(st); enableTurn(st); if(st._mustPlaceBarricade && st._placer===ME) enableBarricadePlacement(st);
  });
}

// ---- BOARD exact 14 lines / 112 nodes ----
const svg=document.getElementById('svg'); const G_E=document.getElementById('edges'); const G_N=document.getElementById('nodes'); const G_H=document.getElementById('homes'); const G_P=document.getElementById('pieces');
const playersEl=document.getElementById('players'); const diceEl=document.getElementById('dice'); const turnEl=document.getElementById('turn');

const COLS=17, DX=50, DY=60, X0=120, Y0=950;
const lines = {
  1:{cols:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]},
  2:{cols:[1,5,9,13,17]},
  3:{cols:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]},
  4:{cols:[3,7,11,15]},
  5:{cols:[3,4,5,6,7,8,9,10,11,12,13,14,15]},
  6:{cols:[5,13]},
  7:{cols:[5,6,7,8,9,10,11,12,13]},
  8:{cols:[7,11]},
  9:{cols:[7,8,9,10,11]},
 10:{cols:[9]},
 11:{cols:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]},
 12:{cols:[1,17]},
 13:{cols:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]},
 14:{cols:[9]}
};

const NODE={}, nodes=[]; let idn=1;
const LC={};
for(let L=1; L<=14; L++){
  const yy = Y0 - (L-1)*DY;
  const cols = lines[L].cols;
  for(let j=0;j<cols.length;j++){
    const col=cols[j];
    const xx = X0 + (col-1)*DX;
    const nid="n"+(idn++);
    const obj={id:nid,x:xx,y:yy,L, col};
    NODE[nid]=obj; nodes.push(obj);
    LC[L+"_"+col]=nid;
  }
}
const adj={};
function conn(a,b){ (adj[a]||(adj[a]=[])).push(b); (adj[b]||(adj[b]=[])).push(a); }

// horizontals
for(let L=1; L<=14; L++){
  const cols=lines[L].cols;
  for(let j=0;j<cols.length-1;j++){
    const a=LC[L+"_"+cols[j]], b=LC[L+"_"+cols[j+1]]; conn(a,b);
  }
}
// verticals where same col exists on consecutive lines
for(let L=1; L<14; L++){
  const cols=lines[L].cols;
  for(const c of cols){
    const a=LC[L+"_"+c], b=LC[(L+1)+"_"+c];
    if(a && b) conn(a,b);
  }
}

function drawEdges(){
  G_E.innerHTML="";
  for(const [a,ns] of Object.entries(adj)){
    const A=NODE[a]; ns.forEach(b=>{ if(a>b) return; const B=NODE[b]; const L=document.createElementNS("http://www.w3.org/2000/svg","line"); L.setAttribute("x1",A.x); L.setAttribute("y1",A.y); L.setAttribute("x2",B.x); L.setAttribute("y2",B.y); L.setAttribute("class","edge"); G_E.appendChild(L); });
  }
}
function drawNodes(){
  G_N.innerHTML="";
  nodes.forEach(n=>{ const c=document.createElementNS("http://www.w3.org/2000/svg","circle"); c.setAttribute("cx",n.x); c.setAttribute("cy",n.y); c.setAttribute("r","12"); c.setAttribute("class","node"); G_N.appendChild(c); });
  // but add an extra "goal" circle above n112, and link it to n112
  const goal = NODE["n112"]; if(goal){ const g=document.createElementNS("http://www.w3.org/2000/svg","circle"); g.setAttribute("cx",goal.x); g.setAttribute("cy",goal.y-40); g.setAttribute("r","14"); g.setAttribute("class","goal"); G_N.appendChild(g); conn("n112","n103"); }
}
function drawHomes(){
  G_H.innerHTML="";
  const by = Y0 + 80;
  function row(baseCol){ const arr=[]; for(let i=0;i<5;i++){ arr.push({x: X0 + (baseCol+i*1)*DX, y: by}); } return arr; }
  const starts = {
    green:  row(2),
    red:    row(6),
    yellow: row(10),
    blue:   row(14)
  };
  for(const [col,arr] of Object.entries(starts)){
    arr.forEach(p=>{ const c=document.createElementNS("http://www.w3.org/2000/svg","circle"); c.setAttribute("cx",p.x); c.setAttribute("cy",p.y); c.setAttribute("r","13"); c.setAttribute("fill",COLORS[col]); G_H.appendChild(c); });
  }
}
drawEdges(); drawNodes(); drawHomes();

const ENTRY={};
ENTRY.green  = LC["11_3"];
ENTRY.red    = LC["11_7"];
ENTRY.yellow = LC["11_11"];
ENTRY.blue   = LC["11_15"];

function occ(players){ const s=new Set(); for(const pl of Object.values(players)){ pl.pawns.forEach(p=>{ if(!p.atHome) s.add(p.pos); }); } return s; }
function drawState(st){
  playersEl.innerHTML="";
  Object.entries(st.players).forEach(([n,p])=>{ const d=document.createElement('div'); d.className='tag'; d.innerHTML=`<span class="dot" style="background:${COLORS[p.color]}"></span>${n}`; playersEl.appendChild(d); });
  diceEl.textContent="Dé : "+(st.dice||"—"); turnEl.textContent=(st.order[st.turnIndex]||"—")+((st.order[st.turnIndex]===ME)?" (à toi)":"");
  drawEdges(); drawNodes(); drawHomes();
  G_P.innerHTML="";
  (st.barricades||[]).forEach(id=>{ const n=NODE[id]; if(!n) return; const b=document.createElementNS("http://www.w3.org/2000/svg","circle"); b.setAttribute("cx",n.x); b.setAttribute("cy",n.y); b.setAttribute("r","11"); b.setAttribute("class","barricade"); G_P.appendChild(b); });
  for(const [name,pl] of Object.entries(st.players)){
    for(let i=0;i<pl.pawns.length;i++){
      const p=pl.pawns[i]; let x,y;
      if(p.atHome){
        const by = Y0+80;
        const base = pl.color==="green"?2:pl.color==="red"?6:pl.color==="yellow"?10:14;
        x = X0 + (base+i)*DX; y=by;
      }else{ const n=NODE[p.pos]; if(!n) continue; x=n.x; y=n.y; }
      const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r","12"); c.setAttribute("fill",COLORS[pl.color]); c.setAttribute("class","pawn"); G_P.appendChild(c);
      const t=document.createElementNS("http://www.w3.org/2000/svg","text"); t.setAttribute("x",x); t.setAttribute("y",y+4); t.setAttribute("text-anchor","middle"); t.setAttribute("font-size","10"); t.textContent=(i+1); G_P.appendChild(t);
    }
  }
}

function reach(start,steps,blocked){ let cur=new Set([start]); for(let s=0;s<steps;s++){ const nxt=new Set(); for(const k of cur){ for(const n of (adj[k]||[])){ if(blocked.has(n)) continue; nxt.add(n);} } cur=nxt; } return cur; }

document.getElementById('roll').onclick = async ()=>{
  await runTransaction(gameRef,(st)=>{ st=ensure(st); if(!st.started) return st; if(st.order[st.turnIndex]!==ME) return st; st.dice=Math.floor(Math.random()*6)+1; return st; });
};

function enableTurn(st){
  if(!st.started) return; if(st.order[st.turnIndex]!==ME || !st.dice) return;
  const me=st.players[ME]; if(!me) return;
  const occupied=occ(st.players); const blocked=new Set([...(st.barricades||[]), ...occupied]);
  me.pawns.forEach((p,idx)=>{
    const start = p.atHome ? ENTRY[me.color] : p.pos;
    if(p.atHome && blocked.has(start)) return;
    if(!p.atHome) blocked.delete(start);
    const dests=Array.from(reach(start,st.dice,blocked));
    const legal=dests.filter(k=>NODE[k]);
    let x,y; if(p.atHome){ const by=Y0+80; const base=me.color==="green"?2:me.color==="red"?6:me.color==="yellow"?10:14; x=X0+(base+idx)*DX; y=by; } else { const n=NODE[p.pos]; x=n.x; y=n.y; }
    const o=document.createElementNS("http://www.w3.org/2000/svg","circle"); o.setAttribute("cx",x); o.setAttribute("cy",y); o.setAttribute("r","16"); o.setAttribute("class","hint"); o.onclick=()=>{ clearHints(); showTargets(legal,(dest)=>movePawn(idx,dest)); }; G_P.appendChild(o);
  });
}
function clearHints(){ [...svg.querySelectorAll(".hint")].forEach(n=>n.remove()); }
function showTargets(keys,onPick){ keys.forEach(k=>{ const n=NODE[k]; if(!n) return; const c=document.createElementNS("http://www.w3.org/2000/svg","circle"); c.setAttribute("cx",n.x); c.setAttribute("cy",n.y); c.setAttribute("r","16"); c.setAttribute("class","hint"); c.onclick=()=>onPick(k); G_P.appendChild(c); }); }

function movePawn(idx,dest){
  runTransaction(gameRef,(st)=>{
    st=ensure(st); if(!st.started) return st; if(st.order[st.turnIndex]!==ME) return st;
    const me=st.players[ME]; const p=me.pawns[idx];
    const start = p.atHome ? ENTRY[me.color] : p.pos;
    const occupied=occ(st.players); const blocked=new Set([...(st.barricades||[]), ...occupied]);
    if(p.atHome && blocked.has(start)) return st; if(!p.atHome) blocked.delete(start);
    const dests=Array.from(reach(start,st.dice,blocked)); if(!dests.includes(dest)) return st;
    for(const [n,pl] of Object.entries(st.players)){ if(n===ME) continue; pl.pawns.forEach(pp=>{ if(!pp.atHome && pp.pos===dest){ pp.atHome=true; pp.pos="home"; } }); }
    p.atHome=false; p.pos=dest;
    if(dest==="n112"){ st.winner=ME; }
    const bi=(st.barricades||[]).indexOf(dest);
    if(bi>=0){ st.barricades.splice(bi,1); st._mustPlaceBarricade=true; st._placer=ME; }
    else { st.dice=0; if(!st.winner) st.turnIndex=(st.turnIndex+1)%st.order.length; }
    return st;
  });
  clearHints();
}
function enableBarricadePlacement(st){
  const occupied=occ(st.players);
  const choices=Object.keys(NODE).filter(id=>id!=="n112" && !occupied.has(id));
  showTargets(choices,(dest)=>{
    runTransaction(gameRef,(S)=>{ S=ensure(S); if(!S._mustPlaceBarricade||S._placer!==ME) return S; if(!NODE[dest]||dest==="n112") return S; if(occ(S.players).has(dest)) return S; S.barricades.push(dest); S._mustPlaceBarricade=false; S._placer=""; S.dice=0; if(!S.winner) S.turnIndex=(S.turnIndex+1)%S.order.length; return S; });
    clearHints();
  });
  log("Place une barricade noire sur une case libre.");
}
</script>
</body></html>
