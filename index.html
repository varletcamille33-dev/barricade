<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Malefiz ‚Äî √âdition Moderne</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Nouvelle palette moderne */
      --bg-app: #e6e9ef;         /* Fond de page gris-bleut√© tr√®s clair */
      --text-main: #1f2937;      /* Texte gris tr√®s fonc√© (plus doux que noir) */
      --text-muted: #6b7280;
      --panel-bg: #ffffff;       /* Cartes en blanc pur */
      --accent: #d97706;         /* Orange moderne pour les actions */
      --accent-hover: #b45309;
      --board-bg: #f3eadd;       /* Fond du plateau (bois clair moderne) */
      --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 16px;
    }

    * { box-sizing: border-box; transition: all 0.2s ease-in-out; }
    
    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: 'Outfit', system-ui, -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px 10px;
    }

    h3 { margin-top: 0; color: var(--text-main); font-weight: 800; letter-spacing: -0.5px; }
    label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; display: block; }

    /* Style des Cartes (Menu & Jeu) */
    .card {
      background: var(--panel-bg);
      border: none; /* On enl√®ve la bordure */
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 1100px;
      box-shadow: var(--shadow-card);
      margin-bottom: 20px;
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { display: flex; flex-direction: column; gap: 6px; }

    /* Inputs et Selects modernes */
    input, select {
      font-family: inherit;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 12px 16px;
      color: var(--text-main);
      font-size: 1rem;
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15);
    }

    /* Boutons Modernes */
    button {
      font-family: inherit;
      border-radius: 8px;
      border: none;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      background: #e5e7eb;
      color: #374151;
      transform: translateY(0);
    }
    button:hover:not(:disabled) {
      background: #d1d5db;
      transform: translateY(-2px);
    }
    button:active:not(:disabled) { transform: translateY(0); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    button.primary {
      background: linear-gradient(135deg, var(--accent), #f59e0b);
      color: white;
      box-shadow: 0 4px 6px rgba(217, 119, 6, 0.3);
    }
    button.primary:hover:not(:disabled) {
      box-shadow: 0 6px 12px rgba(217, 119, 6, 0.4);
      filter: brightness(1.1);
    }

    /* Conteneur du Plateau (Le bois/la table) */
    #wrap {
      overflow: hidden;
      border-radius: var(--radius);
      background: var(--board-bg);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.05); /* Ombre int√©rieure pour la profondeur */
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
    }

    #svg {
      touch-action: none;
      display: block;
      width: 100%;
      height: 70vh;
      /* Petit effet de texture subtil via CSS si d√©sir√©, sinon couleur unie propre */
    }

    /* El√©ments SVG conserv√©s mais nettoy√©s */
    .edge { stroke: #a89f91; stroke-width: 4; stroke-linecap: round; opacity: 0.6; }
    .node { fill: #fffcf5; stroke: #d6cfc2; stroke-width: 2; }
    /* Barricade reste noire mais avec un stroke plus doux */
    .barricade { fill: #1f2937; stroke: #000; stroke-width: 1; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3)); }
    
    /* Pions avec l√©g√®re ombre port√©e pour effet 3D */
    .pawn { stroke: rgba(0,0,0,0.2); stroke-width: 1; filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.2)); }
    
    /* UI Helpers */
    .hint-origin { fill: rgba(255, 255, 255, 0.5); stroke: var(--accent); stroke-width: 3; cursor: pointer; animation: pulse 2s infinite; }
    .hint-target { fill: rgba(217, 119, 6, 0.1); stroke: var(--accent); stroke-width: 3; cursor: pointer; stroke-dasharray: 6 4; }
    .select { fill: transparent; stroke: var(--accent); stroke-width: 4; pointer-events: none; }
    
    @keyframes pulse { 0% { stroke-opacity: 1; } 50% { stroke-opacity: .4; } 100% { stroke-opacity: 1; } }

    /* Tags des joueurs */
    .tag {
      padding: 8px 14px;
      border-radius: 99px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; box-shadow: inset 0 0 2px rgba(0,0,0,0.2); }

    /* Journal et Infos */
    #log {
      height: 160px;
      overflow: auto;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      white-space: pre-wrap;
      font-size: 13px;
      color: #4b5563;
      font-family: monospace;
    }
    .notice { font-size: 13px; color: var(--accent); font-weight: 500; margin-left: 8px; }
    
    /* Info Panel In-Game */
    .game-header {
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #eee;
      margin-bottom: 10px;
    }
    #dice { font-size: 1.1rem; font-weight: 700; color: var(--text-main); background: #f3f4f6; padding: 6px 12px; border-radius: 8px; }
    #turn { color: var(--accent); }

    /* Overlay Victoire */
    #winOverlay {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(31, 41, 55, 0.7); z-index: 9999; backdrop-filter: blur(4px);
    }
    #winBox {
      background: #fff; border: none; border-radius: 24px;
      padding: 40px; max-width: 520px; text-align: center;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    #winBox h2 { margin: 0 0 16px; color: var(--accent); font-size: 2rem; }
    #winBox p { font-size: 1.1rem; line-height: 1.6; color: #4b5563; }
    #winClose { margin-top: 24px; width: 100%; background: var(--text-main); color: #fff; }
  </style>
</head>
<body>

<section id="menu" class="card">
  <h3>üé≤ Malefiz ‚Äî Cr√©er ou Rejoindre</h3>
  <div class="row">
    <div class="col" style="min-width:200px;flex:1">
      <label>Pseudo</label>
      <input id="m_name" placeholder="ex: Camille">
    </div>
    <div class="col" style="width:180px">
      <label>Couleur</label>
      <select id="m_color">
        <option value="red">üî¥ Rouge</option>
        <option value="blue">üîµ Bleu</option>
        <option value="green">üü¢ Vert</option>
        <option value="yellow">üü° Jaune</option>
      </select>
    </div>
    <div class="col" style="min-width:200px;flex:1">
      <label>Code de partie</label>
      <input id="m_game" placeholder="ex: famille1">
    </div>
  </div>
  <div class="row" style="margin-top:20px; justify-content: flex-end;">
    <button id="m_join">Rejoindre</button>
    <button id="m_create" class="primary">Cr√©er la partie</button>
  </div>
  
  <div id="lobby" style="display:none; margin-top:24px; border-top: 1px solid #eee; padding-top: 20px;">
    <div style="margin-bottom:10px; color:#6b7280; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; font-weight:700;">Joueurs dans le salon</div>
    <div id="lobbyList" class="row" style="gap:10px"></div>
    <div class="row" style="margin-top:20px; align-items:center; gap:15px; background:#fff7ed; padding:15px; border-radius:12px; border:1px solid #ffedd5;">
      <button id="m_start" class="primary" style="width:auto;">üöÄ D√©marrer la partie</button>
      <span class="notice" style="color:#9a3412;">‚ö†Ô∏è Seul l'h√¥te peut d√©marrer (Min. 2 joueurs).</span>
    </div>
  </div>
</section>

<section id="game" class="card" style="display:none">
  <div class="game-header row" style="align-items:center; justify-content:space-between">
    <div class="row" style="gap:16px; align-items:center">
      <button id="roll" class="primary">üé≤ Lancer le d√©</button>
      <div id="dice">D√© : ‚Äî</div>
      <div style="font-size:1.1rem;">Tour : <strong id="turn">‚Äî</strong></div>
      <div id="phase" class="notice" style="font-weight:700; font-size:1rem;"></div>
    </div>
    <div id="players" class="row" style="gap:8px"></div>
  </div>

  <div id="wrap" style="margin-top:16px">
    <svg id="svg" viewBox="0 0 1090 1300" xmlns="http://www.w3.org/2000/svg">
      <g id="edges"></g>
      <g id="nodes"></g>
      <g id="homes"></g>
      <g id="pieces"></g>
      <g id="ui"></g>
    </svg>
  </div>

  <div class="col" style="margin-top:20px">
    <div style="font-size:0.9rem; font-weight:700; color:#6b7280; text-transform:uppercase;">Journal de bord</div>
    <div id="log"></div>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// ‚ö†Ô∏è TA CONFIG FIREBASE EST ICI (Je l'ai gard√©e telle quelle)
const firebaseConfig = {
  apiKey: "AIzaSyDqZOF5bsuzH7dH3TvQiY9JknZWXYJsEE4",
  authDomain: "barricade-en-ligne.firebaseapp.com",
  databaseURL: "https://barricade-en-ligne-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "barricade-en-ligne",
  storageBucket: "barricade-en-ligne.firebasestorage.app",
  messagingSenderId: "1094029683667",
  appId: "1:1094029683667:web:e3d6b9ad3b44b337d29d26"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const COLORS={red:"#ef4444",blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b"}; // Couleurs l√©g√®rement ajust√©es pour √™tre plus "vives/modernes" sans changer le sens
const NODES = [{"id": "n1", "x": 120, "y": 900, "n": 1}, {"id": "n2", "x": 170, "y": 900, "n": 2}, {"id": "n3", "x": 220, "y": 900, "n": 3}, {"id": "n4", "x": 270, "y": 900, "n": 4}, {"id": "n5", "x": 320, "y": 900, "n": 5}, {"id": "n6", "x": 370, "y": 900, "n": 6}, {"id": "n7", "x": 420, "y": 900, "n": 7}, {"id": "n8", "x": 470, "y": 900, "n": 8}, {"id": "n9", "x": 520, "y": 900, "n": 9}, {"id": "n10", "x": 570, "y": 900, "n": 10}, {"id": "n11", "x": 620, "y": 900, "n": 11}, {"id": "n12", "x": 670, "y": 900, "n": 12}, {"id": "n13", "x": 720, "y": 900, "n": 13}, {"id": "n14", "x": 770, "y": 900, "n": 14}, {"id": "n15", "x": 820, "y": 900, "n": 15}, {"id": "n16", "x": 870, "y": 900, "n": 16}, {"id": "n17", "x": 920, "y": 900, "n": 17}, {"id": "n18", "x": 120, "y": 840, "n": 18}, {"id": "n19", "x": 320, "y": 840, "n": 19}, {"id": "n20", "x": 520, "y": 840, "n": 20}, {"id": "n21", "x": 720, "y": 840, "n": 21}, {"id": "n22", "x": 920, "y": 840, "n": 22}, {"id": "n23", "x": 120, "y": 780, "n": 23}, {"id": "n24", "x": 170, "y": 780, "n": 24}, {"id": "n25", "x": 220, "y": 780, "n": 25}, {"id": "n26", "x": 270, "y": 780, "n": 26}, {"id": "n27", "x": 320, "y": 780, "n": 27}, {"id": "n28", "x": 370, "y": 780, "n": 28}, {"id": "n29", "x": 420, "y": 780, "n": 29}, {"id": "n30", "x": 470, "y": 780, "n": 30}, {"id": "n31", "x": 520, "y": 780, "n": 31}, {"id": "n32", "x": 570, "y": 780, "n": 32}, {"id": "n33", "x": 620, "y": 780, "n": 33}, {"id": "n34", "x": 670, "y": 780, "n": 34}, {"id": "n35", "x": 720, "y": 780, "n": 35}, {"id": "n36", "x": 770, "y": 780, "n": 36}, {"id": "n37", "x": 820, "y": 780, "n": 37}, {"id": "n38", "x": 870, "y": 780, "n": 38}, {"id": "n39", "x": 920, "y": 780, "n": 39}, {"id": "n40", "x": 220, "y": 720, "n": 40}, {"id": "n41", "x": 420, "y": 720, "n": 41}, {"id": "n42", "x": 620, "y": 720, "n": 42}, {"id": "n43", "x": 820, "y": 720, "n": 43}, {"id": "n44", "x": 220, "y": 660, "n": 44}, {"id": "n45", "x": 270, "y": 660, "n": 45}, {"id": "n46", "x": 320, "y": 660, "n": 46}, {"id": "n47", "x": 370, "y": 660, "n": 47}, {"id": "n48", "x": 420, "y": 660, "n": 48}, {"id": "n49", "x": 470, "y": 660, "n": 49}, {"id": "n50", "x": 520, "y": 660, "n": 50}, {"id": "n51", "x": 570, "y": 660, "n": 51}, {"id": "n52", "x": 620, "y": 660, "n": 52}, {"id": "n53", "x": 670, "y": 660, "n": 53}, {"id": "n54", "x": 720, "y": 660, "n": 54}, {"id": "n55", "x": 770, "y": 660, "n": 55}, {"id": "n56", "x": 820, "y": 660, "n": 56}, {"id": "n57", "x": 320, "y": 600, "n": 57}, {"id": "n58", "x": 720, "y": 600, "n": 58}, {"id": "n59", "x": 320, "y": 540, "n": 59}, {"id": "n60", "x": 370, "y": 540, "n": 60}, {"id": "n61", "x": 420, "y": 540, "n": 61}, {"id": "n62", "x": 470, "y": 540, "n": 62}, {"id": "n63", "x": 520, "y": 540, "n": 63}, {"id": "n64", "x": 570, "y": 540, "n": 64}, {"id": "n65", "x": 620, "y": 540, "n": 65}, {"id": "n66", "x": 670, "y": 540, "n": 66}, {"id": "n67", "x": 720, "y": 540, "n": 67}, {"id": "n68", "x": 420, "y": 480, "n": 68}, {"id": "n69", "x": 620, "y": 480, "n": 69}, {"id": "n70", "x": 420, "y": 420, "n": 70}, {"id": "n71", "x": 470, "y": 420, "n": 71}, {"id": "n72", "x": 520, "y": 420, "n": 72}, {"id": "n73", "x": 570, "y": 420, "n": 73}, {"id": "n74", "x": 620, "y": 420, "n": 74}, {"id": "n75", "x": 520, "y": 360, "n": 75}, {"id": "n76", "x": 120, "y": 300, "n": 76}, {"id": "n77", "x": 170, "y": 300, "n": 77}, {"id": "n78", "x": 220, "y": 300, "n": 78}, {"id": "n79", "x": 270, "y": 300, "n": 79}, {"id": "n80", "x": 320, "y": 300, "n": 80}, {"id": "n81", "x": 370, "y": 300, "n": 81}, {"id": "n82", "x": 420, "y": 300, "n": 82}, {"id": "n83", "x": 470, "y": 300, "n": 83}, {"id": "n84", "x": 520, "y": 300, "n": 84}, {"id": "n85", "x": 570, "y": 300, "n": 85}, {"id": "n86", "x": 620, "y": 300, "n": 86}, {"id": "n87", "x": 670, "y": 300, "n": 87}, {"id": "n88", "x": 720, "y": 300, "n": 88}, {"id": "n89", "x": 770, "y": 300, "n": 89}, {"id": "n90", "x": 820, "y": 300, "n": 90}, {"id": "n91", "x": 870, "y": 300, "n": 91}, {"id": "n92", "x": 920, "y": 300, "n": 92}, {"id": "n93", "x": 120, "y": 240, "n": 93}, {"id": "n94", "x": 920, "y": 240, "n": 94}, {"id": "n95", "x": 120, "y": 180, "n": 95}, {"id": "n96", "x": 170, "y": 180, "n": 96}, {"id": "n97", "x": 220, "y": 180, "n": 97}, {"id": "n98", "x": 270, "y": 180, "n": 98}, {"id": "n99", "x": 320, "y": 180, "n": 99}, {"id": "n100", "x": 370, "y": 180, "n": 100}, {"id": "n101", "x": 420, "y": 180, "n": 101}, {"id": "n102", "x": 470, "y": 180, "n": 102}, {"id": "n103", "x": 520, "y": 180, "n": 103}, {"id": "n104", "x": 570, "y": 180, "n": 104}, {"id": "n105", "x": 620, "y": 180, "n": 105}, {"id": "n106", "x": 670, "y": 180, "n": 106}, {"id": "n107", "x": 720, "y": 180, "n": 107}, {"id": "n108", "x": 770, "y": 180, "n": 108}, {"id": "n109", "x": 820, "y": 180, "n": 109}, {"id": "n110", "x": 870, "y": 180, "n": 110}, {"id": "n111", "x": 920, "y": 180, "n": 111}, {"id": "n112", "x": 520, "y": 120, "n": 112}];

/** Helper: lookup node by id (no NODE_BY_ID global needed) */
function getNodeById(id){
  for (let i=0;i<NODES.length;i++){ const n = NODES[i]; if(n.id===id) return n; }
  return null;
}

const ADJ = {"n112": ["n103"], "n95": ["n96", "n93"], "n96": ["n97", "n95"], "n97": ["n98", "n96"], "n98": ["n99", "n97"], "n99": ["n100", "n98"], "n100": ["n101", "n99"], "n101": ["n102", "n100"], "n102": ["n103", "n101"], "n103": ["n104", "n102", "n112"], "n104": ["n105", "n103"], "n105": ["n106", "n104"], "n106": ["n107", "n105"], "n107": ["n108", "n106"], "n108": ["n109", "n107"], "n109": ["n110", "n108"], "n110": ["n111", "n109"], "n111": ["n110", "n94"], "n93": ["n76", "n95"], "n94": ["n92", "n111"], "n76": ["n77", "n93"], "n77": ["n78", "n76"], "n78": ["n79", "n77"], "n79": ["n80", "n78"], "n80": ["n81", "n79"], "n81": ["n82", "n80"], "n82": ["n83", "n81"], "n83": ["n84", "n82"], "n84": ["n85", "n83", "n75"], "n85": ["n86", "n84"], "n86": ["n87", "n85"], "n87": ["n88", "n86"], "n88": ["n89", "n87"], "n89": ["n90", "n88"], "n90": ["n91", "n89"], "n91": ["n92", "n90"], "n92": ["n91", "n94"], "n75": ["n72", "n84"], "n70": ["n71", "n68"], "n71": ["n72", "n70"], "n72": ["n73", "n71", "n75"], "n73": ["n74", "n72"], "n74": ["n73", "n69"], "n68": ["n61", "n70"], "n69": ["n65", "n74"], "n59": ["n60", "n57"], "n60": ["n61", "n59"], "n61": ["n62", "n60", "n68"], "n62": ["n63", "n61"], "n63": ["n64", "n62"], "n64": ["n65", "n63"], "n65": ["n66", "n64", "n69"], "n66": ["n67", "n65"], "n67": ["n66", "n58"], "n57": ["n46", "n59"], "n58": ["n54", "n67"], "n44": ["n45", "n40"], "n45": ["n46", "n44"], "n46": ["n47", "n45", "n57"], "n47": ["n48", "n46"], "n48": ["n49", "n47", "n41"], "n49": ["n50", "n48"], "n50": ["n51", "n49"], "n51": ["n52", "n50"], "n52": ["n53", "n51", "n42"], "n53": ["n54", "n52"], "n54": ["n55", "n53", "n58"], "n55": ["n56", "n54"], "n56": ["n55", "n43"], "n40": ["n25", "n44"], "n41": ["n29", "n48"], "n42": ["n33", "n52"], "n43": ["n37", "n56"], "n23": ["n24", "n18"], "n24": ["n25", "n23"], "n25": ["n26", "n24", "n40"], "n26": ["n27", "n25"], "n27": ["n28", "n26", "n19"], "n28": ["n29", "n27"], "n29": ["n30", "n28", "n41"], "n30": ["n31", "n29"], "n31": ["n32", "n30", "n20"], "n32": ["n33", "n31"], "n33": ["n34", "n32", "n42"], "n34": ["n35", "n33"], "n35": ["n36", "n34", "n21"], "n36": ["n37", "n35"], "n37": ["n38", "n36", "n43"], "n38": ["n39", "n37"], "n39": ["n38", "n22"], "n18": ["n1", "n23"], "n19": ["n5", "n27"], "n20": ["n9", "n31"], "n21": ["n13", "n35"], "n22": ["n17", "n39"], "n1": ["n2", "n18"], "n2": ["n3", "n1"], "n3": ["n4", "n2"], "n4": ["n5", "n3"], "n5": ["n6", "n4", "n19"], "n6": ["n7", "n5"], "n7": ["n8", "n6"], "n8": ["n9", "n7"], "n9": ["n10", "n8", "n20"], "n10": ["n11", "n9"], "n11": ["n12", "n10"], "n12": ["n13", "n11"], "n13": ["n14", "n12", "n21"], "n14": ["n15", "n13"], "n15": ["n16", "n14"], "n16": ["n17", "n15"], "n17": ["n16", "n22"]};
const HOMES = {"red": [{"x": 120, "y": 1050}, {"x": 170, "y": 1050}, {"x": 220, "y": 1050}, {"x": 270, "y": 1050}, {"x": 320, "y": 1050}], "green": [{"x": 320, "y": 1050}, {"x": 370, "y": 1050}, {"x": 420, "y": 1050}, {"x": 470, "y": 1050}, {"x": 520, "y": 1050}], "yellow": [{"x": 520, "y": 1050}, {"x": 570, "y": 1050}, {"x": 620, "y": 1050}, {"x": 670, "y": 1050}, {"x": 720, "y": 1050}], "blue": [{"x": 720, "y": 1050}, {"x": 770, "y": 1050}, {"x": 820, "y": 1050}, {"x": 870, "y": 1050}, {"x": 920, "y": 1050}]};
const ENTRY = {"red": "n3", "green": "n7", "yellow": "n11", "blue": "n15"};
const BARRS = ["n23", "n27", "n31", "n35", "n39", "n61", "n65", "n72", "n75", "n84", "n103"];

const NODE_BY_ID = Object.fromEntries(NODES.map(n=>[n.id,n]));
const ADJ_SAFE = new Proxy(ADJ, { get: (t, k)=> t[k] || [] });

const menu=document.getElementById('menu'), game=document.getElementById('game');
const mName=document.getElementById('m_name'), mColor=document.getElementById('m_color'), mGame=document.getElementById('m_game');
const mCreate=document.getElementById('m_create'), mJoin=document.getElementById('m_join'), mStart=document.getElementById('m_start');
const lobby=document.getElementById('lobby'), lobbyList=document.getElementById('lobbyList');
const svg=document.getElementById('svg'); const G_E=document.getElementById('edges'); const G_N=document.getElementById('nodes'); const G_H=document.getElementById('homes'); const G_P=document.getElementById('pieces'); const G_UI=document.getElementById('ui');
const playersEl=document.getElementById('players'); const diceEl=document.getElementById('dice'); const turnEl=document.getElementById('turn'); const phaseEl=document.getElementById('phase'); const logEl=document.getElementById('log');
const rollBtn = document.getElementById('roll');

let ME="", MYCOLOR="red", gameRef=null, IS_HOST=false;
let LOCAL_BARR_ADDS = new Set(); // affichage optimiste des barricades pos√©es
let LOCAL_PLACE_DONE = false; // on ferme la phase de placement localement

function blankState(){return{host:"",started:false,order:[],turnIndex:0,dice:0,winner:"",players:{},colors:{red:false,blue:false,green:false,yellow:false},barricades:[]}};
function ensure(st){ if(!st) st=blankState(); st.players=st.players||{}; st.colors=st.colors||{red:false,blue:false,green:false,yellow:false}; st.order=st.order||[]; st.barricades=st.barricades||[]; return st; }
function log(t){ logEl.textContent = t+"\\n"+logEl.textContent; }

// MENU actions
mCreate.onclick = async ()=>{ const id=mGame.value.trim(), name=mName.value.trim(), color=mColor.value; if(!id||!name) return alert("Pseudo + code requis");
  ME=name; MYCOLOR=color; IS_HOST=true; gameRef=ref(db,"games/"+id);
  await set(gameRef, blankState());
  await runTransaction(gameRef,(st)=>{ st=ensure(st); st.host=name; st.players[name]={color,pawns:Array.from({length:5}).map(()=>({pos:"home",atHome:true})),won:false}; st.colors[color]=true; st.order=[name]; return st; });
  subscribe(id); lobby.style.display="block";
};
mJoin.onclick = async ()=>{ const id=mGame.value.trim(), name=mName.value.trim(), color=mColor.value; if(!id||!name) return alert("Pseudo + code requis");
  ME=name; MYCOLOR=color; IS_HOST=false; gameRef=ref(db,"games/"+id);
  await runTransaction(gameRef,(st)=>{ st=ensure(st); if(st.started){alert("Partie d√©j√† d√©marr√©e");return;} if(st.players[name]){alert("Pseudo d√©j√†
